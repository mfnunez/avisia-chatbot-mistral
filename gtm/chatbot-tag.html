<!--
  AVISIA Chatbot - GTM Custom HTML Tag (ES5 Compatible)

  INSTRUCTIONS DE CONFIGURATION :
  1. Copier tout ce code
  2. Dans GTM, créer une nouvelle balise HTML personnalisée
  3. Remplacer YOUR_CLOUD_RUN_URL par l'URL de votre service Cloud Run
  4. Définir le déclencheur sur "Toutes les pages" ou pages spécifiques
  5. Enregistrer et publier
-->

<script>
(function() {
  'use strict';

  // Prevent multiple instances
  if (window.avisiaChatbotLoaded) return;
  window.avisiaChatbotLoaded = true;

  // Configuration - UPDATE THIS URL
  var CLOUD_RUN_URL = 'YOUR_CLOUD_RUN_URL'; // e.g., https://avisia-chatbot-xxx-uc.a.run.app

  // Inject CSS
  var style = document.createElement('style');
  style.textContent = '\
    /* AVISIA Chatbot Styles */\
\
    /* CSS Reset - must come first */\
    * {\
        box-sizing: border-box;\
    }\
\
    .avisia-chatbot-container * {\
        margin: 0;\
        padding: 0;\
    }\
\
    /* Container and positioning */\
    .avisia-chatbot-container {\
        position: fixed;\
        z-index: 999999;\
        font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\
    }\
\
    .avisia-chatbot-container.bottom-right {\
        bottom: 20px;\
        right: 20px;\
    }\
\
    .avisia-chatbot-container.bottom-left {\
        bottom: 20px;\
        left: 20px;\
    }\
\
    .avisia-chatbot-container.top-right {\
        top: 20px;\
        right: 20px;\
    }\
\
    .avisia-chatbot-container.top-left {\
        top: 20px;\
        left: 20px;\
    }\
\
    /* Toggle button */\
    .avisia-chatbot-toggle {\
        width: 60px;\
        height: 60px;\
        border-radius: 30px;\
        background: linear-gradient(135deg, #1d1973 0%, #2ea3f2 100%);\
        border: none;\
        box-shadow: 0 4px 12px rgba(29, 25, 115, 0.4);\
        cursor: pointer;\
        display: flex;\
        align-items: center;\
        justify-content: center;\
        transition: all 0.3s ease;\
        position: relative;\
    }\
\
    .avisia-chatbot-toggle:hover {\
        transform: scale(1.05);\
        box-shadow: 0 6px 16px rgba(29, 25, 115, 0.5);\
    }\
\
    .avisia-chatbot-toggle:active {\
        transform: scale(0.95);\
    }\
\
    .avisia-chatbot-toggle svg {\
        color: white;\
    }\
\
    .avisia-chatbot-badge {\
        position: absolute;\
        top: -5px;\
        right: -5px;\
        background: #2ea3f2;\
        color: white;\
        border-radius: 10px;\
        padding: 2px 5px;\
        font-size: 11px;\
        font-weight: bold;\
        min-width: 16px;\
        text-align: center;\
    }\
\
    /* Chat widget */\
    .avisia-chatbot-widget {\
        width: 380px;\
        height: 550px;\
        background: white;\
        border-radius: 16px;\
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);\
        display: flex;\
        flex-direction: column;\
        overflow: hidden;\
        opacity: 0;\
        transform: scale(0.8) translateY(20px);\
        pointer-events: none;\
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\
    }\
\
    .avisia-chatbot-widget.open {\
        opacity: 1;\
        transform: scale(1) translateY(0);\
        pointer-events: all;\
    }\
\
    /* Header */\
    .avisia-chatbot-header {\
        background: linear-gradient(135deg, #1d1973 0%, #2ea3f2 100%);\
        color: white;\
        padding: 14px 18px;\
        display: flex;\
        justify-content: space-between;\
        align-items: center;\
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\
    }\
\
    .avisia-chatbot-title {\
        display: flex;\
        align-items: center;\
        gap: 10px;\
        font-weight: 600;\
        font-size: 16px;\
        line-height: 1.4;\
        padding-left: 2px;\
    }\
\
    .avisia-chatbot-close {\
        background: transparent;\
        border: none;\
        color: white;\
        cursor: pointer;\
        padding: 4px;\
        padding-right: 2px;\
        display: flex;\
        align-items: center;\
        justify-content: center;\
        border-radius: 6px;\
        transition: background 0.2s ease;\
        flex-shrink: 0;\
    }\
\
    .avisia-chatbot-close:hover {\
        background: rgba(255, 255, 255, 0.1);\
    }\
\
    /* Messages area */\
    .avisia-chatbot-messages {\
        flex: 1;\
        overflow-y: auto;\
        padding: 18px 14px;\
        display: flex;\
        flex-direction: column;\
        gap: 12px;\
        background: #f8f9fa;\
    }\
\
    .avisia-chatbot-messages::-webkit-scrollbar {\
        width: 6px;\
    }\
\
    .avisia-chatbot-messages::-webkit-scrollbar-track {\
        background: transparent;\
    }\
\
    .avisia-chatbot-messages::-webkit-scrollbar-thumb {\
        background: #cbd5e0;\
        border-radius: 3px;\
    }\
\
    .avisia-chatbot-messages::-webkit-scrollbar-thumb:hover {\
        background: #a0aec0;\
    }\
\
    /* Message bubbles */\
    .avisia-message {\
        display: flex;\
        margin-bottom: 4px;\
        animation: slideIn 0.3s ease;\
    }\
\
    @keyframes slideIn {\
        from {\
            opacity: 0;\
            transform: translateY(10px);\
        }\
        to {\
            opacity: 1;\
            transform: translateY(0);\
        }\
    }\
\
    .avisia-message-content {\
        padding: 12px 16px;\
        border-radius: 14px;\
        max-width: 75%;\
        word-wrap: break-word;\
        word-break: break-word;\
        line-height: 1.6;\
        font-size: 14px;\
        box-sizing: border-box;\
    }\
\
    .avisia-message-content strong {\
        font-weight: 600;\
        color: inherit;\
    }\
\
    .avisia-message-user .avisia-message-content {\
        background: linear-gradient(135deg, #1d1973 0%, #2ea3f2 100%);\
        color: white;\
        margin-left: auto;\
        border-bottom-right-radius: 6px;\
        box-shadow: 0 2px 8px rgba(29, 25, 115, 0.15);\
    }\
\
    .avisia-message-assistant .avisia-message-content {\
        background: white;\
        color: #2d3748;\
        border: 1px solid #e2e8f0;\
        border-bottom-left-radius: 6px;\
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);\
    }\
\
    /* Loading animation */\
    .avisia-message-loading .avisia-message-content {\
        padding: 12px;\
    }\
\
    .avisia-loading-dots {\
        display: flex;\
        gap: 4px;\
        align-items: center;\
    }\
\
    .avisia-loading-dots span {\
        width: 8px;\
        height: 8px;\
        border-radius: 50%;\
        background: #cbd5e0;\
        animation: bounce 1.4s infinite ease-in-out both;\
    }\
\
    .avisia-loading-dots span:nth-child(1) {\
        animation-delay: -0.32s;\
    }\
\
    .avisia-loading-dots span:nth-child(2) {\
        animation-delay: -0.16s;\
    }\
\
    @keyframes bounce {\
        0%, 80%, 100% {\
            transform: scale(0);\
            opacity: 0.5;\
        }\
        40% {\
            transform: scale(1);\
            opacity: 1;\
        }\
    }\
\
    /* Input area */\
    .avisia-chatbot-input-area {\
        display: flex;\
        gap: 8px;\
        padding: 14px 16px;\
        background: white;\
        border-top: 1px solid #e2e8f0;\
        overflow: visible;\
    }\
\
    .avisia-chatbot-input {\
        flex: 1;\
        border: 1px solid #e2e8f0;\
        border-radius: 24px;\
        padding: 10px 14px;\
        font-size: 14px;\
        outline: none;\
        transition: all 0.2s ease;\
        font-family: inherit;\
        margin: 2px;\
    }\
\
    .avisia-chatbot-input:focus {\
        border-color: #1d1973;\
        box-shadow: 0 0 0 3px rgba(29, 25, 115, 0.1);\
        margin: 2px;\
    }\
\
    .avisia-chatbot-input::placeholder {\
        color: #a0aec0;\
    }\
\
    .avisia-chatbot-send {\
        width: 40px;\
        height: 40px;\
        border-radius: 20px;\
        background: linear-gradient(135deg, #1d1973 0%, #2ea3f2 100%);\
        border: none;\
        color: white;\
        cursor: pointer;\
        display: flex;\
        align-items: center;\
        justify-content: center;\
        transition: all 0.2s ease;\
        flex-shrink: 0;\
    }\
\
    .avisia-chatbot-send:hover {\
        transform: scale(1.05);\
        box-shadow: 0 4px 12px rgba(29, 25, 115, 0.3);\
    }\
\
    .avisia-chatbot-send:active {\
        transform: scale(0.95);\
    }\
\
    .avisia-chatbot-send:disabled {\
        opacity: 0.5;\
        cursor: not-allowed;\
    }\
\
    /* Mobile responsiveness */\
    @media (max-width: 480px) {\
        .avisia-chatbot-widget {\
            width: calc(100vw - 20px);\
            height: calc(100vh - 80px);\
            max-height: none;\
            border-radius: 12px;\
        }\
\
        .avisia-chatbot-container.bottom-right,\
        .avisia-chatbot-container.bottom-left {\
            bottom: 10px;\
            right: 10px;\
            left: 10px;\
        }\
\
        .avisia-chatbot-toggle {\
            width: 56px;\
            height: 56px;\
        }\
\
        .avisia-chatbot-header {\
            padding: 12px 14px;\
        }\
\
        .avisia-chatbot-title {\
            font-size: 15px;\
        }\
\
        .avisia-chatbot-messages {\
            padding: 16px 12px;\
            gap: 10px;\
        }\
\
        .avisia-message-content {\
            max-width: 85%;\
            font-size: 14px;\
            padding: 10px 14px;\
            line-height: 1.55;\
        }\
\
        .avisia-chatbot-input-area {\
            padding: 12px 14px;\
            gap: 6px;\
        }\
\
        .avisia-chatbot-input {\
            padding: 9px 12px;\
            font-size: 14px;\
        }\
    }\
\
    @media (max-width: 380px) {\
        .avisia-message-content {\
            max-width: 90%;\
            font-size: 13px;\
            padding: 9px 12px;\
            line-height: 1.5;\
        }\
    }\
\
    .avisia-chatbot-toggle:focus-visible,\
    .avisia-chatbot-close:focus-visible,\
    .avisia-chatbot-send:focus-visible,\
    .avisia-chatbot-input:focus-visible {\
        outline: 2px solid #1d1973;\
        outline-offset: 2px;\
    }\
  ';
  document.head.appendChild(style);

  // Load chatbot JavaScript
  var script = document.createElement('script');
  script.text = '(function() {\
    "use strict";\
    \
    var CONFIG = {\
      API_ENDPOINT: "' + CLOUD_RUN_URL + '",\
      POSITION: "bottom-right",\
      PRIMARY_COLOR: "#1d1973",\
      ACCENT_COLOR: "#2ea3f2",\
      STORAGE_KEY: "avisia_chatbot_history",\
      MAX_MESSAGES: 20,\
      EXTRACTION_DELAY: 1000\
    };\
    \
    var conversationHistory = [];\
    var isOpen = false;\
    var isLoading = false;\
    var pageContent = "";\
    \
    function extractPageContent() {\
      var excludeSelectors = ["nav", "header", "footer", "aside", "[role=navigation]", "[role=banner]", "[role=complementary]", ".nav", ".navbar", ".menu", ".sidebar", ".advertisement", ".ad", ".ads", ".promo", "script", "style", "noscript", "iframe", "[class*=cookie]", "[id*=cookie]", "[class*=popup]", "[class*=modal]", ".chatbot", "#avisia-chatbot"];\
      var prioritySelectors = ["main", "article", "[role=main]", ".content", ".main-content", "#content", ".article", ".post", ".entry"];\
      var content = "";\
      \
      for (var i = 0; i < prioritySelectors.length; i++) {\
        var elements = document.querySelectorAll(prioritySelectors[i]);\
        if (elements.length > 0) {\
          for (var j = 0; j < elements.length; j++) {\
            var clone = elements[j].cloneNode(true);\
            for (var k = 0; k < excludeSelectors.length; k++) {\
              var excludedEls = clone.querySelectorAll(excludeSelectors[k]);\
              for (var l = 0; l < excludedEls.length; l++) {\
                excludedEls[l].remove();\
              }\
            }\
            content += clone.innerText + "\\n\\n";\
          }\
          if (content.trim().length > 100) {\
            return cleanContent(content);\
          }\
        }\
      }\
      \
      var bodyClone = document.body.cloneNode(true);\
      for (var m = 0; m < excludeSelectors.length; m++) {\
        var excludedBodyEls = bodyClone.querySelectorAll(excludeSelectors[m]);\
        for (var n = 0; n < excludedBodyEls.length; n++) {\
          excludedBodyEls[n].remove();\
        }\
      }\
      content = bodyClone.innerText;\
      return cleanContent(content);\
    }\
    \
    function cleanContent(text) {\
      return text.replace(/\\s+/g, " ").replace(/\\n\\s*\\n\\s*\\n/g, "\\n\\n").trim().substring(0, 50000);\
    }\
    \
    function loadHistory() {\
      try {\
        var stored = sessionStorage.getItem(CONFIG.STORAGE_KEY);\
        if (stored) {\
          conversationHistory = JSON.parse(stored);\
        }\
      } catch (e) {\
        console.warn("Erreur lors du chargement de l\'historique:", e);\
      }\
    }\
    \
    function saveHistory() {\
      try {\
        if (conversationHistory.length > CONFIG.MAX_MESSAGES) {\
          conversationHistory = conversationHistory.slice(-CONFIG.MAX_MESSAGES);\
        }\
        sessionStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(conversationHistory));\
      } catch (e) {\
        console.warn("Erreur lors de la sauvegarde de l\'historique:", e);\
      }\
    }\
    \
    function createChatbotUI() {\
      var container = document.createElement("div");\
      container.id = "avisia-chatbot";\
      container.className = "avisia-chatbot-container " + CONFIG.POSITION;\
      container.innerHTML = "<div class=\\"avisia-chatbot-widget" + (isOpen ? " open" : "") + "\\"><div class=\\"avisia-chatbot-header\\"><div class=\\"avisia-chatbot-title\\"><svg width=\\"20\\" height=\\"20\\" viewBox=\\"0 0 24 24\\" fill=\\"none\\" stroke=\\"currentColor\\"><path d=\\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\\"/></svg><span>Assistant AVISIA</span></div><button class=\\"avisia-chatbot-close\\" aria-label=\\"Fermer le chat\\"><svg width=\\"20\\" height=\\"20\\" viewBox=\\"0 0 24 24\\" fill=\\"none\\" stroke=\\"currentColor\\"><line x1=\\"18\\" y1=\\"6\\" x2=\\"6\\" y2=\\"18\\"/><line x1=\\"6\\" y1=\\"6\\" x2=\\"18\\" y2=\\"18\\"/></svg></button></div><div class=\\"avisia-chatbot-messages\\" id=\\"avisia-chatbot-messages\\"><div class=\\"avisia-message avisia-message-assistant\\"><div class=\\"avisia-message-content\\">Bonjour ! Je suis l\'assistant virtuel d\'AVISIA. Je peux vous aider à découvrir nos expertises en data, IA et transformation digitale. Comment puis-je vous aider ?</div></div></div><div class=\\"avisia-chatbot-input-area\\"><input type=\\"text\\" class=\\"avisia-chatbot-input\\" id=\\"avisia-chatbot-input\\" placeholder=\\"Posez votre question...\\" autocomplete=\\"off\\"/><button class=\\"avisia-chatbot-send\\" id=\\"avisia-chatbot-send\\" aria-label=\\"Envoyer le message\\"><svg width=\\"20\\" height=\\"20\\" viewBox=\\"0 0 24 24\\" fill=\\"currentColor\\"><path d=\\"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z\\"/></svg></button></div></div><button class=\\"avisia-chatbot-toggle\\" id=\\"avisia-chatbot-toggle\\" aria-label=\\"Ouvrir le chat\\"><svg width=\\"24\\" height=\\"24\\" viewBox=\\"0 0 24 24\\" fill=\\"currentColor\\"><path d=\\"M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z\\"/></svg><span class=\\"avisia-chatbot-badge\\" id=\\"avisia-chatbot-badge\\" style=\\"display: none;\\">1</span></button>";\
      document.body.appendChild(container);\
      attachEventListeners();\
      loadHistory();\
      renderHistory();\
    }\
    \
    function attachEventListeners() {\
      var toggle = document.getElementById("avisia-chatbot-toggle");\
      var close = document.querySelector(".avisia-chatbot-close");\
      var input = document.getElementById("avisia-chatbot-input");\
      var send = document.getElementById("avisia-chatbot-send");\
      toggle.addEventListener("click", toggleChat);\
      close.addEventListener("click", toggleChat);\
      send.addEventListener("click", sendMessage);\
      input.addEventListener("keypress", function(e) {\
        if (e.key === "Enter" && !e.shiftKey) {\
          e.preventDefault();\
          sendMessage();\
        }\
      });\
    }\
    \
    function toggleChat() {\
      isOpen = !isOpen;\
      var widget = document.querySelector(".avisia-chatbot-widget");\
      var toggle = document.getElementById("avisia-chatbot-toggle");\
      var badge = document.getElementById("avisia-chatbot-badge");\
      if (isOpen) {\
        widget.classList.add("open");\
        toggle.style.display = "none";\
        document.getElementById("avisia-chatbot-input").focus();\
        badge.style.display = "none";\
        \
        pushGTMEvent("chatbot_opened", {\
          conversation_length: conversationHistory.length,\
          page_url: window.location.href\
        });\
      } else {\
        widget.classList.remove("open");\
        toggle.style.display = "flex";\
        \
        pushGTMEvent("chatbot_closed", {\
          conversation_length: conversationHistory.length,\
          page_url: window.location.href\
        });\
      }\
    }\
    \
    function renderHistory() {\
      var messagesContainer = document.getElementById("avisia-chatbot-messages");\
      var welcomeMsg = messagesContainer.querySelector(".avisia-message-assistant");\
      messagesContainer.innerHTML = "";\
      messagesContainer.appendChild(welcomeMsg);\
      for (var i = 0; i < conversationHistory.length; i++) {\
        addMessageToUI(conversationHistory[i].role, conversationHistory[i].content, false);\
      }\
      scrollToBottom();\
    }\
    \
    function addMessageToUI(role, content, shouldScroll) {\
      if (shouldScroll === undefined) shouldScroll = true;\
      var messagesContainer = document.getElementById("avisia-chatbot-messages");\
      var messageDiv = document.createElement("div");\
      messageDiv.className = "avisia-message avisia-message-" + role;\
      messageDiv.innerHTML = "<div class=\\"avisia-message-content\\">" + escapeHtml(content) + "</div>";\
      messagesContainer.appendChild(messageDiv);\
      if (shouldScroll) {\
        scrollToBottom();\
      }\
    }\
    \
    function showLoading() {\
      var messagesContainer = document.getElementById("avisia-chatbot-messages");\
      var loadingDiv = document.createElement("div");\
      loadingDiv.className = "avisia-message avisia-message-assistant avisia-message-loading";\
      loadingDiv.id = "avisia-loading";\
      loadingDiv.innerHTML = "<div class=\\"avisia-message-content\\"><div class=\\"avisia-loading-dots\\"><span></span><span></span><span></span></div></div>";\
      messagesContainer.appendChild(loadingDiv);\
      scrollToBottom();\
    }\
    \
    function removeLoading() {\
      var loading = document.getElementById("avisia-loading");\
      if (loading) {\
        loading.remove();\
      }\
    }\
    \
    function scrollToBottom() {\
      var messagesContainer = document.getElementById("avisia-chatbot-messages");\
      messagesContainer.scrollTop = messagesContainer.scrollHeight;\
    }\
    \
    function pushGTMEvent(eventName, eventParams) {\
      window.dataLayer = window.dataLayer || [];\
      window.dataLayer.push({\
        event: eventName,\
        chatbot_name: "avisia_chatbot",\
        chatbot_params: eventParams\
      });\
    }\
    \
    function sendMessage() {\
      var input = document.getElementById("avisia-chatbot-input");\
      var message = input.value.trim();\
      if (!message || isLoading) return;\
      \
      var conversationTurn = Math.floor((conversationHistory.length + 1) / 2) + 1;\
      \
      pushGTMEvent("chatbot_message_sent", {\
        message_length: message.length,\
        conversation_turn: conversationTurn,\
        page_url: window.location.href\
      });\
      \
      addMessageToUI("user", message);\
      conversationHistory.push({ role: "user", content: message });\
      saveHistory();\
      input.value = "";\
      isLoading = true;\
      showLoading();\
      if (!pageContent) {\
        pageContent = extractPageContent();\
      }\
      var messageStartTime = new Date().getTime();\
      fetch(CONFIG.API_ENDPOINT + "/api/chat", {\
        method: "POST",\
        headers: { "Content-Type": "application/json" },\
        body: JSON.stringify({\
          message: message,\
          pageContent: pageContent,\
          pageUrl: window.location.href,\
          conversationHistory: conversationHistory.slice(0, -1)\
        })\
      }).then(function(response) {\
        if (!response.ok) {\
          throw new Error("Erreur API: " + response.status);\
        }\
        return response.json();\
      }).then(function(data) {\
        var responseTime = new Date().getTime() - messageStartTime;\
        removeLoading();\
        addMessageToUI("assistant", data.response);\
        conversationHistory.push({ role: "assistant", content: data.response });\
        saveHistory();\
        isLoading = false;\
        \
        pushGTMEvent("chatbot_response_received", {\
          response_length: data.response.length,\
          response_time_ms: responseTime,\
          conversation_turn: conversationTurn,\
          page_url: window.location.href\
        });\
      }).catch(function(error) {\
        console.error("Erreur chat:", error);\
        removeLoading();\
        addMessageToUI("assistant", "Désolé, une erreur est survenue. Veuillez réessayer ou contacter un expert AVISIA.");\
        isLoading = false;\
        \
        pushGTMEvent("chatbot_error", {\
          error_message: error.message,\
          conversation_turn: conversationTurn,\
          page_url: window.location.href\
        });\
      });\
    }\
    \
    function escapeHtml(text) {\
      var div = document.createElement("div");\
      div.textContent = text;\
      var escaped = div.innerHTML;\
      escaped = escaped.replace(/\\n/g, "<br>");\
      escaped = escaped.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, "<a href=\\"$2\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\" style=\\"color: #1d1973; text-decoration: underline;\\">$1</a>");\
      escaped = escaped.replace(/\\*\\*([^*]+)\\*\\*/g, "<strong>$1</strong>");\
      escaped = escaped.replace(/\\*([^*]+)\\*/g, "<em>$1</em>");\
      return escaped;\
    }\
    \
    function init() {\
      if (document.readyState === "loading") {\
        document.addEventListener("DOMContentLoaded", init);\
        return;\
      }\
      setTimeout(function() {\
        pageContent = extractPageContent();\
        createChatbotUI();\
      }, CONFIG.EXTRACTION_DELAY);\
    }\
    \
    init();\
  })();';

  document.body.appendChild(script);

})();
</script>
